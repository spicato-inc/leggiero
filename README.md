# leggiero

**leggiero** は Node.js 用の画像圧縮ツールです。

名前は音楽用語で『軽い、軽やかで優美に』という意味で、画像ファイルを軽くするという意味を込めています。

`sharp` を利用して JPEG, PNG, GIF などの画像を圧縮し、出力先ディレクトリに同じディレクトリ構造で保存します。また、WEBP 形式への変換も対応しています（ただし、ファイル名に「no-webp」が含まれている場合は変換をスキップします）。
SVG は複製のみ行います。

## 特徴

- **all モード**
  指定したソースディレクトリ内の全画像を再帰的に処理し、圧縮した画像を出力先に保存します。

- **watch モード**
  ソースディレクトリ内のファイル変更を監視し、変更された画像のみを即時圧縮します。
  （`onchange` 経由で変更を検知します）

- ソースディレクトリと同じディレクトリ構造を出力先に再現

## インストール

このパッケージをインストールすると必要な依存パッケージ（sharp, onchange）は自動的にインストールされます。
グローバルインストール例:

```bash
npm install -g @spicato-inc/leggiero
```

## 使い方

シンボリックリンクなどでグローバルコマンドとして利用可能です。

### 圧縮 (all モード)

ディレクトリ内の全画像を圧縮して出力先に保存します。
出力先を指定しない場合は `public` が使用されます。

```bash
leggiero all <source-directory> [dest-directory]
```

例:

```bash
leggiero all src/assets/images public
```

### 監視 (watch モード)

指定したソースディレクトリの画像変更を監視し、自動で圧縮処理を実行します。
出力先を指定しない場合は `public` が使用されます。

```bash
leggiero watch <source-directory> [dest-directory]
```

### 設定ファイル

プロジェクトのルートディレクトリに `.leggierorc` ファイルを作成することで、画像圧縮の品質設定やディレクトリ設定をカスタマイズできます。

```json
{
  "quality": {
    "jpg": 70,
    "png": 70,
    "gif": 70,
    "webp": 70
  },
  "input": "src/images",
  "output": "public"
}
```

設定ファイルについて：

- 設定ファイルが存在しない場合は、デフォルト値が使用されます
- 数値が大きいほど高品質・低圧縮となります（0-100の範囲）
- ディレクトリ設定を含めることで、コマンドライン引数を省略できます
- コマンドライン引数が指定された場合、コマンドライン引数が設定ファイルの値より優先されます

設定ファイルはJSONスキーマによって検証されます。不正な値や範囲外の値を指定した場合、警告メッセージが表示され、デフォルト値が使用されます。

## 動作の流れ

1. **all モード**

   - ソースディレクトリを再帰的に探索し、各画像の相対パスをもとに出力先ディレクトリを決定。
   - 画像を圧縮または複製（SVG）し、WEBP 変換も行います（例外: ファイル名に「no-webp」が含まれる場合）。

2. **watch モード**
   - `npx onchange` 経由でファイル変更を検知し、変更されたファイル毎に圧縮処理を実行。
   - 変更されたファイルの出力先は、元のパス中の "src" を指定した出力先に置換して決定します。

## 注意事項

- 出力先ディレクトリが存在しない場合、自動的に再帰的に作成します。
- 圧縮処理に失敗すると、エラーメッセージが出力され、処理はスキップされます。
- `no-webp` が含まれるファイル名の場合、WEBP 変換は実行されません。

## ライセンス

MIT License
© spicato inc.
